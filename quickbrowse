#!/usr/bin/env python3

import sys

from PyQt5.QtCore import QUrl, Qt
from PyQt5.QtWidgets import QApplication, QMainWindow, QToolBar, QAction, \
     QLineEdit, QStatusBar, QProgressBar
from PyQt5.QtWebEngineWidgets import QWebEngineView, QWebEnginePage, \
     QWebEngineProfile

from PyQt5 import QtWidgets

class ReadlineEdit(QLineEdit):
    def __init__(self):
        super (ReadlineEdit, self).__init__()

    def keyPressEvent(self, event):
        # http://pyqt.sourceforge.net/Docs/PyQt4/qt.html#Key-enum
        if (event.modifiers() & Qt.ControlModifier):
            k = event.key()
            if k == Qt.Key_Control:
                return
            if k == Qt.Key_A:
                self.home(False)
            elif k == Qt.Key_E:
                self.end(False)
            elif k == Qt.Key_B:
                self.cursorBackward(False, 1)
            elif k == Qt.Key_F:
                self.cursorForward(False, 1)
            elif k == Qt.Key_H:
                self.backspace()
            elif k == Qt.Key_D:
                self.del_()
            elif k == Qt.Key_W:
                self.cursorWordBackward(True)
                self.del_()
            elif k == Qt.Key_U:
                self.clear()
            else:
                # call base class keyPressEvent
                QLineEdit.keyPressEvent(self, event)

class BrowserWindow(QMainWindow):
    def __init__(self, *args, **kwargs):
        super(BrowserWindow, self).__init__(*args, **kwargs)

        self.setWindowTitle("Quickbrowse")

        toolbar = QToolBar("Toolbar")
        self.addToolBar(toolbar)

        btn_act = QAction("Back", self)
        # for an icon: QAction(QIcon("bug.png"), "Your button", self)
        btn_act.setStatusTip("Go back")
        btn_act.triggered.connect(self.go_back)
        toolbar.addAction(btn_act)

        btn_act = QAction("Forward", self)
        btn_act.setStatusTip("Go forward")
        btn_act.triggered.connect(self.go_forward)
        toolbar.addAction(btn_act)

        btn_act = QAction("Reload", self)
        btn_act.setStatusTip("Reload")
        btn_act.triggered.connect(self.reload)
        toolbar.addAction(btn_act)

        self.urlbar = ReadlineEdit()
        self.urlbar.setPlaceholderText("URL goes here")
        self.urlbar.returnPressed.connect(self.urlbar_load)
        toolbar.addWidget(self.urlbar)

        #
        # Set up the WebEngineView
        #
        self.webview = QWebEngineView()

        # We need a QWebEnginePage in order to get linkHovered events,
        # and to set a profile.
        self.profile = QWebEngineProfile()    # New anonymous (supposedly) profile:
        print("Profile off the record?", self.profile.isOffTheRecord())
        self.webenginepage = QWebEnginePage(self.profile)
        print("Webpage off the record?", self.webenginepage.profile().isOffTheRecord())

        self.webview.setPage(self.webenginepage)

        self.setCentralWidget(self.webview)
        self.webview.urlChanged.connect(self.url_changed)
        self.webview.loadStarted.connect(self.load_started)
        self.webview.loadFinished.connect(self.load_finished)
        self.webview.loadProgress.connect(self.load_progress)
        self.webenginepage.linkHovered.connect(self.link_hover)

        self.setStatusBar(QStatusBar(self))
        self.progress = QProgressBar()
        self.statusBar().addPermanentWidget(self.progress)

        # Key bindings
        # For keys like function keys, use QtGui.QKeySequence("F12")
        QtWidgets.QShortcut("Ctrl+Q", self, activated = self.close)
        QtWidgets.QShortcut("Ctrl+L", self, activated = self.select_urlbar)

        self.resize(1024, 768)

    def update_buttons(self):
        # check e.g. self.webview.page().action(QWebEnginePage.Back).isEnabled())
        pass

    def load_url(self, url):
        self.webview.load(QUrl(url))
        print("load_url", url)
        print("Profile off the record?", self.profile.isOffTheRecord())
        print("Webpage off the record?", self.webenginepage.profile().isOffTheRecord())

    def select_urlbar(self):
        self.urlbar.selectAll()
        self.urlbar.setFocus()

    #
    # Slots
    #

    def urlbar_load(self):
        url = self.urlbar.text()
        print("load url from urlbar", url)
        val = self.webview.load(QUrl(url))
        print("load returned", val)

    def go_back(self):
        self.webview.back()

    def go_forward(self):
        self.webview.forward()

    def reload(self):
        self.webview.reload()

    def url_changed(self, url):
        if url != self.urlbar.text():
            # I can't find any way to find out about load errors.
            # But an attempted load that fails gives a url_changed(about:blank)
            # so maybe we can detect it that way.
            if url.toString() == 'about:blank':
                print("Couldn't load " + self.urlbar.text())
                self.statusBar().showMessage("Couldn't load "
                                             + self.urlbar.text())
            else:
                self.urlbar.setText(url.toDisplayString())

    def link_hover(self, url):
        self.statusBar().showMessage(url)

    def load_started(self):
        self.progress.show()

    def load_finished(self, ok):
        # OK is useless: if we try to load a bad URL, we won't get a
        # loadFinished on that; instead it will switch to about:blank,
        # load that successfully and call loadFinished with ok=True.
        self.progress.hide()

    def load_progress(self, progress):
        self.progress.setValue(progress)

#
# PyQt is super crashy. Any little error, like an extra argument in a slot,
# causes it to kill Python with a core dump.
# Setting sys.excepthook works around this behavior, and execution continues.
#
def excepthook(excType=None, excValue=None, tracebackobj=None, *,
               message=None, version_tag=None, parent=None):
    print("exception! excValue='%s'" % excValue)

sys.excepthook = excepthook
# sys.excepthook = traceback.print_exception

if __name__ == '__main__':
    app = QApplication(sys.argv)
    win = BrowserWindow()
    if len(sys.argv) > 1:
        win.load_url(sys.argv[1])
    win.show()
    app.exec_()

